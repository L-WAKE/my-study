<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
</head>

<body>
    <script>
        // list 所罗门
        //深克隆
        function deepCloneMax(obj) {
            if ([null, undefined, NaN, false].includes(obj)) return obj;
            if (typeof obj !== "object" && typeof obj !== "function") return obj;
            let newObj = Array.isArray(obj) ? [] : {};
            for (let key in obj) {
                if (obj.hasOwnProperty(key)) {
                    newObj[key] =
                        typeof obj[key] == "object" ? deepCloneMax(obj[key]) : obj[key];
                }
            }
            return newObj;
        }

        //获取某个节点的所有父节点
        function getAllParentNodes(list, id) {
            for (let i in list) {
                if (list[i].id == id) {
                    return [list[i]].filter(v => v.id != id)
                }
                if (list[i].children?.length > 0) {
                    let node = getAllParentNodes(list[i].children, id)
                    if (node) return node.concat(list[i]).filter(v => v.id != id)
                }
            }
        }

        let region = [
            {
                firstCol: 0,
                lastCol: 2,
                firstRow: 0,
                lastRow: 0,
            },
            {
                firstCol: 0,
                lastCol: 1,
                firstRow: 1,
                lastRow: 1,
            },
            {
                firstCol: 2,
                lastCol: 2,
                firstRow: 1,
                lastRow: 2,
            },
            {
                firstCol: 3,
                lastCol: 3,
                firstRow: 0,
                lastRow: 2,
            },
        ];
        let cells = [
            [
                {
                    v: "用户",
                    expression: "",
                    properties: {},
                },
                {
                    v: "用户",
                    expression: "",
                    properties: {},
                },
                {
                    v: "用户",
                    expression: "",
                    properties: {},
                },
                {
                    v: "城区名称",
                    expression: "",
                    properties: {},
                },
            ],
            [
                {
                    v: "1",
                    expression: "",
                    properties: {},
                },
                {
                    v: "1",
                    expression: "",
                    properties: {},
                },
                {
                    v: "4",
                    expression: "",
                    properties: {},
                },
                {
                    v: "城区名称",
                    expression: "",
                    properties: {},
                },
            ],
            [
                {
                    v: "2",
                    expression: "",
                    properties: {},
                },
                {
                    v: "3",
                    expression: "",
                    properties: {},
                },
                {
                    v: "4",
                    expression: "",
                    properties: {},
                },
                {
                    v: "城区名称",
                    expression: "",
                    properties: {},
                },
            ],
        ];
        //第一个表的数据
        const theadData1 = [
            {
                label: "用户",
                id: "user",
                children: [
                    {
                        label: "1",
                        id: "one",
                        children: [
                            { label: "2", id: "two", children: [] },
                            { label: "3", id: "three", children: [] },
                        ],
                    },
                    { label: "4", id: "four", children: [] },
                ],
            },
            {
                id: "city",
                label: "城区名称",
                children: [],
            },
        ];

        //第二个表的数据
        const theadData2 = [
            {
                label: "用户",
                children: [
                    {
                        label: "11",
                        children: [],
                    },
                    {
                        label: "22",
                        children: [],
                    },
                ],
            },
            {
                label: "城区名称",
                children: [
                    {
                        label: "33",
                        children: [
                            {
                                label: "44",
                                children: [],
                            },
                        ],
                    },
                ],
            },
        ];

        //四级表头数据
        const theadData3 = [
            {
                align: "left",
                label: "用户",
                prop: "279_1",
                width: "",
                type: "dim",
                orderType: "",
                clumType: "dimension",
                index: 0,
                children: [
                    {
                        label: "1",
                        isHide: false,
                        id: 1678521451157,
                        index: 1678521451157,
                        children: [],
                        align: "left",
                        warnEnable: false,
                        conceal: false,
                        warnThresholdOperator: "==",
                    },
                    {
                        label: "2",
                        id: 1678521468353,
                        index: 1678521468353,
                        isHide: false,
                        children: [
                            {
                                label: "7",
                                isHide: false,
                                id: 1678522567299,
                                index: 1678522567299,
                                children: [
                                    {
                                        label: "8",
                                        isHide: false,
                                        id: 1678522571576,
                                        index: 1678522571576,
                                        children: [],
                                        align: "left",
                                        warnEnable: false,
                                        conceal: false,
                                        warnThresholdOperator: "==",
                                    },
                                ],
                                align: "left",
                                warnEnable: false,
                                conceal: false,
                                warnThresholdOperator: "==",
                            },
                        ],
                        align: "left",
                        warnEnable: false,
                        conceal: false,
                        warnThresholdOperator: "==",
                    },
                    {
                        label: "3",
                        id: 1678521453653,
                        index: 1678521453653,
                        isHide: false,
                        children: [
                            {
                                label: "4",
                                isHide: false,
                                id: 1678521456117,
                                index: 1678521456117,
                                children: [],
                                align: "left",
                                warnEnable: false,
                                conceal: false,
                                warnThresholdOperator: "==",
                            },
                        ],
                        align: "left",
                        warnEnable: false,
                        conceal: false,
                        warnThresholdOperator: "==",
                    },
                ],
                isHide: false,
                conceal: false,
                id: 1678521444663,
                warnEnable: false,
                warnThresholdOperator: "==",
            },
            {
                align: "left",
                label: "城区名称",
                prop: "280_1",
                width: "",
                type: "dim",
                orderType: "",
                clumType: "dimension",
                index: 1,
                children: [
                    {
                        label: "9",
                        isHide: false,
                        id: 1678522576689,
                        index: 1678522576689,
                        children: [
                            {
                                label: "5",
                                isHide: false,
                                id: 1678521458992,
                                index: 1678521458992,
                                children: [],
                                align: "left",
                                warnEnable: false,
                                conceal: false,
                                warnThresholdOperator: "==",
                            },
                        ],
                        align: "left",
                        warnEnable: false,
                        conceal: false,
                        warnThresholdOperator: "==",
                    },
                    {
                        label: "6",
                        id: 1678521461896,
                        index: 1678521461896,
                        isHide: false,
                        children: [
                            {
                                label: "10",
                                isHide: false,
                                id: 1678522581923,
                                index: 1678522581923,
                                children: [
                                    {
                                        label: "11",
                                        isHide: false,
                                        id: 1678522579083,
                                        index: 1678522579083,
                                        children: [],
                                        align: "left",
                                        warnEnable: false,
                                        conceal: false,
                                        warnThresholdOperator: "==",
                                    },
                                ],
                                align: "left",
                                warnEnable: false,
                                conceal: false,
                                warnThresholdOperator: "==",
                            },
                        ],
                        align: "left",
                        warnEnable: false,
                        conceal: false,
                        warnThresholdOperator: "==",
                    },
                ],
                isHide: false,
                conceal: false,
                id: 1678521444664,
                warnEnable: false,
                warnThresholdOperator: "==",
            },
        ];

        //珏珏的数据
        const theadData4 = [
            {
                conceal: false,
                orderType: "",
                index: 0,
                label: "Date",
                align: "center",
                type: "dim",
                drill: "none",
                isHide: false,
                children: [],
                warnThresholdOperator: "==",
                warnEnable: false,
                prop: "342_3",
                width: "",
                id: 1678435304952,
                clumType: "dimension",
            },
            {
                conceal: false,
                orderType: "",
                index: 1,
                label: "DIM_OFFERING_NAME",
                align: "center",
                type: "dim",
                drill: "none",
                isHide: false,
                children: [],
                warnThresholdOperator: "==",
                warnEnable: false,
                prop: "343_1",
                width: "",
                id: 1678435304953,
                clumType: "dimension",
            },
            {
                conceal: false,
                children: [
                    {
                        conceal: false,
                        children: [
                            {
                                conceal: false,
                                orderType: "",
                                index: 2,
                                label: "mo_on_times",
                                align: "center",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_55",
                                width: "",
                                indLine: false,
                                id: 1678435304954,
                                clumType: "indicator",
                            },
                            {
                                conceal: false,
                                orderType: "",
                                index: 3,
                                label: "mo_on_amount",
                                align: "left",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_56",
                                width: "",
                                indLine: false,
                                id: 1678435304955,
                                clumType: "indicator",
                            },
                        ],
                        warnThresholdOperator: "==",
                        warnEnable: false,
                        index: 1678435313917,
                        label: "On net",
                        id: 1678435313917,
                        align: "center",
                    },
                    {
                        conceal: false,
                        children: [
                            {
                                conceal: false,
                                orderType: "",
                                index: 4,
                                label: "mo_off_times",
                                align: "left",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_57",
                                width: "",
                                indLine: false,
                                id: 1678435304956,
                                clumType: "indicator",
                            },
                            {
                                conceal: false,
                                orderType: "",
                                index: 5,
                                label: "mo_off_amount",
                                align: "left",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_58",
                                width: "",
                                indLine: false,
                                id: 1678435304957,
                                clumType: "indicator",
                            },
                        ],
                        warnThresholdOperator: "==",
                        warnEnable: false,
                        index: 1678435313919,
                        label: "Off Net",
                        id: 1678435313919,
                        align: "center",
                    },
                    {
                        conceal: false,
                        children: [
                            {
                                conceal: false,
                                orderType: "",
                                index: 6,
                                label: "mo_int_times",
                                align: "left",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_59",
                                width: "",
                                indLine: false,
                                id: 1678435304958,
                                clumType: "indicator",
                            },
                            {
                                conceal: false,
                                orderType: "",
                                index: 7,
                                label: "mo_int_amount",
                                align: "left",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_60",
                                width: "",
                                indLine: false,
                                id: 1678435304959,
                                clumType: "indicator",
                            },
                        ],
                        warnThresholdOperator: "==",
                        warnEnable: false,
                        index: 1678435313921,
                        label: "International",
                        id: 1678435313921,
                        align: "center",
                    },
                ],
                warnThresholdOperator: "==",
                warnEnable: false,
                index: 1678435321767,
                label: "SMS(MO)",
                id: 1678435321767,
                align: "center",
            },
            {
                conceal: false,
                children: [
                    {
                        conceal: false,
                        children: [
                            {
                                conceal: false,
                                orderType: "",
                                index: 8,
                                label: "mt_on_times",
                                align: "left",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_61",
                                width: "",
                                indLine: false,
                                id: 1678435304960,
                                clumType: "indicator",
                            },
                            {
                                conceal: false,
                                orderType: "",
                                index: 9,
                                label: "mt_on_amount",
                                align: "left",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_62",
                                width: "",
                                indLine: false,
                                id: 1678435304961,
                                clumType: "indicator",
                            },
                        ],
                        warnThresholdOperator: "==",
                        warnEnable: false,
                        index: 1678435313923,
                        label: "On net",
                        id: 1678435313923,
                        align: "center",
                    },
                    {
                        conceal: false,
                        children: [
                            {
                                conceal: false,
                                orderType: "",
                                index: 10,
                                label: "mt_off_times",
                                align: "left",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_63",
                                width: "",
                                indLine: false,
                                id: 1678435304962,
                                clumType: "indicator",
                            },
                            {
                                conceal: false,
                                orderType: "",
                                index: 11,
                                label: "mt_off_amount",
                                align: "left",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_64",
                                width: "",
                                indLine: false,
                                id: 1678435304963,
                                clumType: "indicator",
                            },
                        ],
                        warnThresholdOperator: "==",
                        warnEnable: false,
                        index: 1678435313925,
                        label: "Off Net",
                        id: 1678435313925,
                        align: "center",
                    },
                    {
                        conceal: false,
                        children: [
                            {
                                conceal: false,
                                orderType: "",
                                index: 12,
                                label: "mt_int_times",
                                align: "left",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_65",
                                width: "",
                                indLine: false,
                                id: 1678435304964,
                                clumType: "indicator",
                            },
                            {
                                conceal: false,
                                orderType: "",
                                index: 13,
                                label: "mt_int_amount",
                                align: "left",
                                type: "ind",
                                isHide: false,
                                children: [],
                                warnThresholdOperator: "==",
                                warnEnable: false,
                                prop: "indicator_66",
                                width: "",
                                indLine: false,
                                id: 1678435304965,
                                clumType: "indicator",
                            },
                        ],
                        warnThresholdOperator: "==",
                        warnEnable: false,
                        index: 1678435313927,
                        label: "International",
                        id: 1678435313927,
                        align: "center",
                    },
                ],
                warnThresholdOperator: "==",
                warnEnable: false,
                index: 1678435321773,
                label: "SMS(MT)",
                id: 1678435321773,
                align: "center",
            },
            {
                conceal: false,
                children: [
                    {
                        conceal: false,
                        orderType: "",
                        index: 14,
                        label: "Items",
                        type: "exp",
                        align: "left",
                        isHide: false,
                        children: [],
                        warnThresholdOperator: "==",
                        warnEnable: false,
                        prop: "indicator_-1",
                        width: "",
                        id: 1678435702877,
                        clumType: "expression",
                    },
                    {
                        conceal: false,
                        orderType: "",
                        index: 15,
                        label: "Amout(SBD)",
                        type: "exp",
                        align: "left",
                        isHide: false,
                        children: [],
                        warnThresholdOperator: "==",
                        warnEnable: false,
                        prop: "indicator_-2",
                        width: "",
                        id: 1678435702878,
                        clumType: "expression",
                    },
                ],
                warnThresholdOperator: "==",
                warnEnable: false,
                index: 1678439759275,
                label: "ToTal",
                id: 1678439759275,
                align: "center",
                isHide: false,
            },
        ];

        //五级表头的数据
        const theadData = [
            {
                align: "left",
                label: "用户",
                prop: "279_1",
                width: "",
                type: "dim",
                orderType: "",
                clumType: "dimension",
                index: 0,
                children: [
                    {
                        label: "2",
                        isHide: false,
                        id: 1678670216060,
                        index: 1678670216060,
                        children: [],
                        align: "left",
                        warnEnable: false,
                        conceal: false,
                        warnThresholdOperator: "==",
                    },
                ],
                isHide: false,
                conceal: false,
                id: 1678670211931,
                warnEnable: false,
                warnThresholdOperator: "==",
            },
            {
                align: "left",
                label: "城区名称",
                prop: "280_1",
                width: "",
                type: "dim",
                orderType: "",
                clumType: "dimension",
                index: 1,
                children: [
                    {
                        label: "1",
                        isHide: false,
                        id: 1678670224194,
                        index: 1678670224194,
                        children: [
                            {
                                label: "3",
                                isHide: false,
                                id: 1678670226847,
                                index: 1678670226847,
                                children: [
                                    {
                                        label: "6",
                                        isHide: false,
                                        id: 1678671163312,
                                        index: 1678671163312,
                                        children: [
                                            {
                                                label: "7",
                                                isHide: false,
                                                id: 1678671166049,
                                                index: 1678671166049,
                                                children: [],
                                                align: "left",
                                                warnEnable: false,
                                                conceal: false,
                                                warnThresholdOperator: "==",
                                            },
                                        ],
                                        align: "left",
                                        warnEnable: false,
                                        conceal: false,
                                        warnThresholdOperator: "==",
                                    },
                                ],
                                align: "left",
                                warnEnable: false,
                                conceal: false,
                                warnThresholdOperator: "==",
                            },
                        ],
                        align: "left",
                        warnEnable: false,
                        conceal: false,
                        warnThresholdOperator: "==",
                    },
                    {
                        label: "4",
                        id: 1678671160762,
                        index: 1678671160762,
                        isHide: false,
                        children: [
                            {
                                label: "8",
                                isHide: false,
                                id: 1678671184884,
                                index: 1678671184884,
                                children: [],
                                align: "left",
                                warnEnable: false,
                                conceal: false,
                                warnThresholdOperator: "==",
                            },
                        ],
                        align: "left",
                        warnEnable: false,
                        conceal: false,
                        warnThresholdOperator: "==",
                    },
                    {
                        label: "9",
                        id: 1678671173835,
                        index: 1678671173835,
                        isHide: false,
                        children: [],
                        align: "left",
                        warnEnable: false,
                        conceal: false,
                        warnThresholdOperator: "==",
                    },
                ],
                isHide: false,
                conceal: false,
                id: 1678670211932,
                warnEnable: false,
                warnThresholdOperator: "==",
            },
            {
                label: "5",
                id: 1678670220853,
                index: 1678670220853,
                isHide: false,
                children: [
                    {
                        label: "10",
                        isHide: false,
                        id: 1678671178419,
                        index: 1678671178419,
                        children: [],
                        align: "left",
                        warnEnable: false,
                        conceal: false,
                        warnThresholdOperator: "==",
                    },
                ],
                align: "left",
                warnEnable: false,
                conceal: false,
                warnThresholdOperator: "==",
            },
        ];

        // 查询最深层级有多少级
        function getMaxlevel(treeData, type) {
            let level = 0;
            let maxLevel = 0;
            function loop(data, level) {
                data.forEach((item) => {
                    item[type] = level;
                    if (level > maxLevel) {
                        maxLevel = level;
                    }
                    if ("children" in item) {
                        if (item.children.length > 0) {
                            loop(item.children, level + 1);
                        }
                    }
                });
            }
            loop(treeData, 1);
            return maxLevel;
        }
        let maxlevel = getMaxlevel(theadData, "level");
        console.log("原始数据theadData", theadData);
        console.log("最大层级maxlevel", maxlevel);

        //获取所有的叶子节点
        const findLeaf = (list) => {
            let allLeaf = [];
            const findf = (data) => {
                data.forEach((item) => {
                    if (item.children && item.children.length > 0) {
                        findf(item.children);
                    } else allLeaf.push(item);
                });
            };
            findf(list);
            return allLeaf;
        };
        let allDocument = findLeaf(theadData);
        console.log("叶子节点allDocument", allDocument);

        //先分层级 有多少级
        const formatArrB = (arr) => {
            let initArr = [];
            const format = (ar, i) => {
                initArr[i] || (initArr[i] = []);
                ar.forEach((val) => {
                    initArr[i].push(val);
                    if (Array.isArray(val.children) && val.children.length > 0) {
                        format(val.children, i + 1); // 此处不能用i++或者++i，因为循环可能还未完成
                    }
                });
                return initArr;
            };
            return format(arr, 0);
        };
        let format = formatArrB(deepCloneMax(theadData));
        console.log("先分层级format", format);

        let testFather = getAllParentNodes(theadData, '1678671184884')
        console.log('测试获取父节点', testFather)

        //对数据排序
        const setSort = (arr) => {
            let sortArr = []
            arr.forEach(item => {
                let parent = getAllParentNodes(theadData, item.id)
                let obj = {
                    parent: parent,
                    level: item.level
                }
                sortArr.push(obj)
            })
            console.log('sortArr888', sortArr)
        }

        let flatList = deepCloneMax(format);
        flatList = flatList.flat();
        console.log("flatList", flatList);
        let cellsHand = [];
        const opreter = (list) => {
            let cells = [];
            list.forEach((item, index) => {
                let itemArr = [];
                item.forEach((iv, ix) => {
                    let itemLeaf = []; //存储每一个层级元素的叶子节点
                    let level = 0;
                    if (iv.children && iv.children.length > 0) {
                        level = getMaxlevel(iv.children, "findLevel");
                        itemLeaf = findLeaf(iv.children);
                    }
                    level = level + 1;
                    let leafLen = itemLeaf.length;
                    if (leafLen == 0) {
                        itemArr.push({
                            level: iv.level,
                            v: iv.label,
                            id: iv.id,
                            expression: "",
                            properties: {},
                        });
                    }
                    for (let i = 0; i < leafLen; i++) {
                        itemArr.push({
                            level: iv.level,
                            v: iv.label,
                            id: iv.id,
                            expression: "",
                            properties: {},
                        });
                    }
                    let itemlen = item.length;
                    let arrlen = itemArr.length;
                    let alllen = allDocument.length;
                    if (ix == itemlen - 1 && arrlen < alllen) {
                        let gapNumber = alllen - arrlen; //当前节点与最大长度节点相差多少个叶子-向上查找补差额
                        let nowLevel = iv.level;
                        for (let j = 0; j < gapNumber; j++) {
                            if (itemArr.length == alllen) break //如果已经有叶子节点个元素 则跳出循环
                            let findAdd = format[nowLevel - 2 - j]; // 上一层级的所有节点
                            let notChild =
                                findAdd.filter(
                                    (h) => !(h.children && h.children.length > 0)
                                ) || [];
                            if (notChild.length >= 1) {
                                //当上一级有多个节点没有children 则把没有children的数据追加
                                notChild.forEach((n) => {
                                    itemArr.push({
                                        level: n.level,
                                        v: n.label,
                                        id: n.id,
                                        expression: "",
                                        properties: {},
                                    });
                                });
                            }
                        }
                    }

                    console.log(iv.label + "--itemLeaf", itemLeaf);
                    console.log(iv.label + "--level", iv.level, level);
                });

                setSort(itemArr) //对数据进行排序
                cells.push(itemArr);
            });
            console.log("cells9999999999", cells);
        };
        opreter(format);


      // let handleArr = [
      //     ['用户', '用户', '用户', '城区名称'],
      //     ['1', '1', '4', '城区名称'],
      //     ['2', '3', '4', '城区名称'],
      // ]
      // let overArr = []

      // const setArr = (list) => {
      //     list.forEach((item, index) => {
      //         overArr.push(item.label)
      //     })
      // }

      // let level = 1
      // const setLevel = (list) => {
      //     let len = list.length
      //     list.forEach((item, index) => {
      //         item.level = level
      //         if (item.children && item.children.length > 0) {
      //             level = level + 1
      //             setLevel(item.children)
      //         }
      //     })
      // }
      // setLevel(theadData)
      // console.log(theadData)
    </script>
</body>

</html>